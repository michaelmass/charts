suite: test certificate
templates:
  - 'certificate.yaml'
tests:
  - it: manifest should match snapshot
    set:
      certificate:
        enabled: true
        issuerRef:
          name: letsencrypt-prod
        dnsNames:
          - example.com
    asserts:
      - matchSnapshot: {}

  - it: labels & annotations should be set
    set:
      common:
        labels:
          test_common: test
        annotations:
          test_common: test
      certificate:
        enabled: true
        issuerRef:
          name: letsencrypt-prod
        labels:
          test_cert: bar
        annotations:
          test_cert: bar
    asserts:
      - isKind:
          of: Certificate
      - isSubset:
          path: metadata.labels
          content:
            test_common: test
            test_cert: bar
      - isSubset:
          path: metadata.annotations
          content:
            test_common: test
            test_cert: bar

  - it: should set issuerRef and dnsNames
    set:
      certificate:
        enabled: true
        issuerRef:
          name: letsencrypt-staging
          kind: Issuer
        dnsNames:
          - app.example.com
          - "*.app.example.com"
    asserts:
      - equal:
          path: spec.issuerRef.name
          value: letsencrypt-staging
      - equal:
          path: spec.issuerRef.kind
          value: Issuer
      - contains:
          path: spec.dnsNames
          content: app.example.com

  - it: should set custom secretName
    set:
      certificate:
        enabled: true
        secretName: my-tls-secret
        issuerRef:
          name: letsencrypt-prod
    asserts:
      - equal:
          path: spec.secretName
          value: my-tls-secret
